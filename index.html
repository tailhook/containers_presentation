<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Linux Containers Ecosystem</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="my.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress"><div class="step" step="0" id="title" data-x="0" data-y="0"><img src="pycon.png" alt="" width="" height=""></img><h1 id="linux-containers-ecosystem">Linux Containers Ecosystem</h1></div><div class="step" step="1" data-scale="2" data-x="500" data-y="0"></div><div class="step" step="2" id="internals" data-x="1000" data-y="-500" data-scale="1"><h1 id="internals">Internals</h1></div><div class="step" step="3" data-x="3000" data-y="-1500" data-scale="1"><h1 id="process-management">Process Management</h1></div><div class="step" step="4" data-x="5000" data-y="-1500" data-scale="1"><p>The most obvious way:</p><pre class="highlight code python"><span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></pre></div><div class="step" step="5" data-x="7000" data-y="-1500" data-scale="1"><p>Low level API:</p><pre class="highlight code python"><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">spawnve</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div><div class="step" step="6" data-x="9000" data-y="-1500" data-scale="1"><p>Even more low level:</p><pre class="highlight code python"><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Fork failed"</span>
<span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div><div class="step" step="7" data-x="11000" data-y="-1500" data-scale="1"><p><tt>fork()</tt> at system call level (<tt>strace</tt>):</p><pre class="highlight ">clone(child_stack=0,
    flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD,
    child_tidptr=0x7fcd0e8539d0) = 8697</pre></div><div class="step" step="8" data-x="13000" data-y="-1500" data-scale="1"><p>Finally namespaces (bad example!):</p><pre class="highlight code python part1"><span class="kn">import</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">ctypes</span><span class="o">,</span> <span class="nn">os</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s">'libc.so.6'</span><span class="p">,</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">CLONE_NEWPID</span> <span class="o">=</span> <span class="mh">0x20000000</span>
<span class="n">CLONE_NEWUSER</span> <span class="o">=</span> <span class="mh">0x10000000</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">create_string_buffer</span><span class="p">(</span><span class="mh">0x200000</span><span class="p">),</span> <span class="mh">0x200000</span><span class="p">)</span></pre><pre class="highlight code python part2"><span class="n">CHILDFUNC</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
<span class="nd">@CHILDFUNC</span>
<span class="k">def</span> <span class="nf">childfunc</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"CHILD"</span><span class="p">,</span> <span class="s">"pid:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="s">"uid:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span>
    <span class="k">return</span> <span class="mi">0</span></pre><pre class="highlight code python part3"><span class="n">pid</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">childfunc</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span>
    <span class="n">CLONE_NEWPID</span><span class="o">|</span><span class="n">CLONE_NEWUSER</span><span class="o">|</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Clone error"</span>
<span class="k">print</span><span class="p">(</span><span class="s">"PARENT"</span><span class="p">,</span> <span class="s">"pid:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="s">"uid:"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">(),</span> <span class="s">"child:"</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div><div class="step" step="9" id="clone_part1" data-x="13100" data-y="-1550" data-scale="0.7"></div><div class="step" step="10" id="clone_part2" data-x="13100" data-y="-1450" data-scale="0.7"></div><div class="step" step="11" id="clone_part3" data-x="13100" data-y="-1300" data-scale="0.7"></div><div class="step" step="12" data-x="15100" data-scale="1" data-y="-1300"><p>Output (the order of lines is arbitrary):</p><pre class="highlight ">$ python3 clone.py
PARENT pid: 14305 uid: 1000 child: 14306
CHILD pid: 1 uid: 65534</pre></div><div class="step" step="13" data-x="17100" data-y="-1300" data-scale="1"><p>Namespaces:</p><ul><li>CLONE_NEWIPC</li><li>CLONE_NEWNET</li><li>CLONE_NEWNS</li><li>CLONE_NEWPID</li><li>CLONE_NEWUTS</li><li>CLONE_NEWUSER</li></ul></div><div class="step" step="14" data-x="19100" data-y="-1300" data-scale="1"><p>But there is <tt>chroot</tt> since 1993!</p></div><div class="step" step="15" id="fs_table" data-x="21100" data-y="-1300" data-scale="1"><table cellpadding="0" cellspacing="0"><tbody><tr><td><p>/var/lib/lxc/ubuntu/rootfs</p></td><td></td></tr><tr><td></td><td><ul><li>/usr</li><li>/var</li><li>/dev</li><li>...</li></ul></td></tr><tr><td><p>/var/lib/lxc/nix/rootfs</p></td><td></td></tr><tr><td></td><td><ul><li>/nix</li><li>/run</li><li>...</li></ul></td></tr></tbody></table></div><div class="step" step="16" data-x="23100" data-y="-1300" data-scale="1"><p>With root privileges you can just:</p><pre class="highlight code python"><span class="n">os</span><span class="o">.</span><span class="n">chroot</span><span class="p">(</span><span class="s">'/var/lib/lxc/ubuntu/rootfs'</span><span class="p">)</span></pre></div><div class="step" step="17" data-x="25100" data-y="-1300" data-scale="1"><h1 id="clone-newns">CLONE_NEWNS</h1><p>mount namespaces</p><p>available in 2.4.19 (2003)</p></div><div class="step" step="18" data-x="27100" data-y="-1300" data-scale="1"><p><tt>mount --bind</tt></p><p>available in 2.4.0 (2001)</p></div><div class="step" step="19" data-x="29100" data-y="-1300" data-scale="1"><p>Create hierarchy in new mount namespace:</p><pre class="highlight code bash">mount --bind /var/lib/lxc/ubuntu/rootfs <span class="se">\
</span>             /usr/lib/lxc/rootfs
mount --bind /dev <span class="se">\
</span>             /usr/lib/lxc/rootfs/dev
mount -t tmpfs tmpfs /usr/lib/lxc/rootfs/tmp
<span class="c"># note .../rootfs/{dev,tmp} still empty
</span>chroot /usr/lib/lxc/rootfs bash</pre></div><div class="step" step="20" data-x="31100" data-y="-1300" data-scale="1"><h1 id="clone-newpid">CLONE_NEWPID</h1><ul><li>own pid 1</li><li><tt>KILL</tt>'ed when pid 1 dead</li><li>separate <tt>/proc</tt></li><li><tt>SIG_IGN</tt> for <tt>SIGTERM</tt> and friends</li></ul></div><div class="step" step="21" data-x="33100" data-y="-1300" data-scale="1"><h1 id="clone-newipc">CLONE_NEWIPC</h1><ul><li>semaphores</li><li>message queues</li><li>etc.</li></ul></div><div class="step" step="22" data-x="35100" data-y="-1300" data-scale="1"><h1 id="clone-newuts">CLONE_NEWUTS</h1><ul><li><tt>hostname</tt></li></ul></div><div class="step" step="23" data-x="37100" data-y="-1300" data-scale="1"><h1 id="clone-newnet">CLONE_NEWNET</h1><ul><li>network interfaces</li><li>iptables rules</li><li>localhost</li><li>abstract unix sockets</li></ul></div><div class="step" step="24" data-x="39100" data-y="-1300" data-scale="1"><h1 id="id1">CLONE_NEWNET</h1><p>useful on its own using <tt>ip netns</tt></p></div><div class="step" step="25" data-x="41100" data-y="-1300" data-scale="1"><h1 id="clone-newuser">CLONE_NEWUSER</h1><p>containers by unprivileged users</p></div><div class="step" step="26" data-scale="2" data-x="500" data-y="0"></div><div class="step" step="27" id="security" data-scale="1" data-x="1000" data-y="0"><h1 id="security">Security</h1></div><div class="step" step="28" data-x="3000" data-y="0" data-scale="1"><h1 id="running-as-root">Running as Root</h1><blockquote><p>... we don&#x2019;t claim Docker out-of-the-box
is suitable for containing untrusted
programs with root privileges ...</p></blockquote><div class="cite"><span class="cite_label">Source: </span><cite>Solomon Hykes</cite></div></div><div class="step" step="29" data-x="5000" data-y="0" data-scale="1"><h1 id="running-as-non-root">Running as non-Root</h1><pre class="highlight code bash">docker run --user<span class="o">=</span>1000 something</pre></div><div class="step" step="30" id="docker_root_lie" data-x="5000" data-y="0" data-scale="1"><p class="lie">Lie</p></div><div class="step" step="31" data-x="7000" data-y="0" data-scale="1"><p>Can become root by any binary with setuid set:</p><p>(e.g. <tt>su</tt>, <tt>sudo</tt>)</p><p>So can be broken on untrusted images</p><p>(e.g. by replacing <tt>/etc/sudoers</tt>)</p></div><div class="step" step="32" data-x="9000" data-y="0" data-scale="1"><h1 id="docker">Docker</h1><ul><li>Always use <tt>--user=</tt></li><li>Never use untrusted images</li></ul></div><div class="step" step="33" data-x="11000" data-y="0" data-scale="1"><h1 id="docker-socket">Docker Socket</h1></div><div class="step" step="34" data-x="13000" data-y="0" data-scale="1"><p>Docker command workflow:</p><p><tt>docker run ubuntu bash</tt></p><p>--&gt; HTTP --&gt; /var/run/docker.sock --&gt;</p><p><tt>docker -d</tt></p></div><div class="step" step="35" data-x="15000" data-y="0" data-scale="1"><p>Docker socket permissions:</p><pre class="highlight ">srw-rw---- 1 root docker Oct  7 23:23 \
    /var/run/docker.sock</pre><p>Which is basically equivalent to:</p><pre class="highlight ">%docker ALL=(ALL) NOPASSWD: ALL</pre></div><div class="step" step="36" data-x="17000" data-y="0" data-scale="1"><p>In case it's not obvious:</p><pre class="highlight ">docker run -it --rm \
    --privileged \
    --volume /:/host \
    ubuntu rm -rf /host</pre></div><div class="step" step="37" data-x="19000" data-y="0" data-scale="1"><p>Never run:</p><pre class="highlight ">docker -d -H 127.0.0.1</pre><p>(any hostname, even localhost)</p><p>Without:</p><pre class="highlight ">docker -d --tlscacert --tlsverify</pre></div><div class="step" step="38" data-x="21000" data-y="0" data-scale="1"><p>But that's not enough!</p></div><div class="step" step="39" data-x="23000" data-y="0" data-scale="1"><h1 id="skydock">SkyDock</h1><ul><li>Service discovery for docker</li><li>Listens docker events</li><li>Publishes them as DNS records</li></ul></div><div class="step" step="40" data-x="25000" data-y="0" data-scale="1"><p>Running as:</p><pre class="highlight ">docker run -d \
-v /var/run/docker.sock:/docker.sock \
crosbymichael/skydock</pre></div><div class="step" step="41" data-x="27000" data-y="0" data-scale="1"><p>breaking skydock</p><p>=</p><p>breaking host system</p></div><div class="step" step="42" data-x="29000" data-y="0" data-scale="1"><h1 id="breaking-clusters">Breaking Clusters</h1></div><div class="step" step="43" data-scale="0.5" data-x="31000" data-y="0"><img src="docker_cloud.svg" alt="" width="" height=""></img></div><div class="step" step="44" id="docker_cloud_firewalled" data-scale="1" data-x="31000" data-y="-50"><img src="docker_cloud_firewalled.svg" alt="" width="" height=""></img></div><div class="step" step="45" data-x="33000" data-y="-50" data-scale="1"><img src="docker_cloud_broken.svg" alt="" width="" height=""></img></div><div class="step" step="46" data-x="35000" data-y="-50" data-scale="1"><ul><li>Use ACLs in Zookeeper</li><li>Use Auth <em>and</em> Firewall</li><li>Don't trust local machines</li></ul></div><div class="step" step="47" data-x="37000" data-y="-50" data-scale="1"><h1 id="untrusted-images">Untrusted Images</h1><ul><li>setuid binaries</li><li>networking code</li><li>DoS</li></ul></div><div class="step" step="48" data-x="39000" data-y="-50" data-scale="1"><h1 id="untrusted-infrastructure-images">Untrusted Infrastructure Images</h1><ul><li>load-balancer</li><li>service-discovery</li><li>statistics</li></ul></div><div class="step" step="49" data-x="41000" data-y="-50" data-scale="1"><h1 id="insufficently-authenticated-repositories">Insufficently Authenticated Repositories</h1></div><div class="step" step="50" data-x="43000" data-y="-50" data-scale="1"><img src="docker_dev_break.svg" alt="" width="" height=""></img></div><div class="step" step="51" data-x="45000" data-y="-50" data-scale="1"><img src="docker_s3_break.svg" alt="" width="" height=""></img></div><div class="step" step="52" data-scale="2" data-x="500" data-y="0"></div><div class="step" step="53" id="tools" data-x="1000" data-y="500" data-scale="1"><h1 id="tools">Tools</h1></div><div class="step" step="54" data-x="3000" data-y="1500" data-scale="1"><h1 id="low-level-tools">Low Level Tools</h1><ul><li>lxc  / lxc-exec</li><li>docker</li><li>warden</li><li>systemd-nspawn</li><li>unshare</li></ul></div><div class="step" step="55" data-x="5000" data-y="1500" data-scale="1"><h1 id="id2">Docker</h1><pre class="highlight strikethrough">docker run ubuntu bash</pre><pre class="highlight ">sudo docker run -it --rm \
    --user $(id -u)
    --volume $(pwd):/workdir \
    --workdir /workdir \
    our.repo.local/foobar:$(get_version) \
    bash</pre></div><div class="step" step="56" data-x="7000" data-y="1500" data-scale="1"><h1 id="dev-env-tools">Dev Env Tools</h1><ul><li>vagrant-lxc</li><li>vagrant-docker</li><li>fig (on top of docker)</li><li>vagga (on top of nothing)</li></ul></div><div class="step" step="57" data-x="9000" data-y="1500" data-scale="1"><h1 id="vagga">Vagga</h1><ul><li>simple YAML config (+versioning)</li><li>user namespaces (no root/setuid)</li><li>multiple process monitoring</li><li>only for dev.env.</li></ul></div><div class="step" step="58" data-x="11000" data-y="1500" data-scale="1"><pre class="highlight code yaml"><span class="c1"># vagga.yaml</span>
<span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
  <span class="s">'react'</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">builder</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">npm</span>
    <span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">react-tools</span>
<span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
  <span class="s">'build'</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">container</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">react</span>
    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">"Build</span><span class="nv"> </span><span class="s">static</span><span class="nv"> </span><span class="s">files"</span>
    <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span> <span class="s">"jsx</span><span class="nv"> </span><span class="s">jsx/page.jsx</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">public/js/page.js"</span></pre></div><div class="step" step="59" data-x="13000" data-y="1500" data-scale="1"><pre class="highlight code console"><span class="gp">$</span> git clone git://github.com/.../foobar
<span class="gp">$</span> <span class="nb">cd </span>foobar
<span class="gp">$</span> vagga
<span class="go">Available commands:
    build       Build static files
    run         Run nginx+app+redis
    build-docs  Build docs
</span><span class="gp">$</span> vagga build</pre></div><div class="step" step="60" data-x="15000" data-y="1500" data-scale="1"><pre class="highlight "># docker tree
-+= 00001 root systemd --system
 |-+- 10771 root docker -d
 | \--= 32029 root bash   &lt;&lt; our process
 \-+= 30029 pc tmux
   \-+= 10718 pc -zsh     &lt;&lt; our shell
     \--= 32021 pc docker run -it --rm bash</pre><pre class="highlight "># vagga tree
-+= 00001 root systemd --system
 \-+= 30029 pc tmux
   \-+= 10358 pc -zsh        &lt;&lt; our shell
     \-+= 00940 pc vagga bash
       \-+- 00941 pc vagga bash
         \--= 00942 pc bash  &lt;&lt; our process</pre></div><div class="step" step="61" data-x="17000" data-y="1500" data-scale="1"><img src="vagga.svg" alt="" width="500" height=""></img><ul><li><a href="http://github.com/tailhook/vagga">http://github.com/tailhook/vagga</a></li><li><a href="http://vagga.readthedocs.org">http://vagga.readthedocs.org</a></li></ul></div><div class="step" step="62" data-x="19000" data-y="1500" data-scale="1"><h1 id="production-tools">Production Tools</h1><table cellpadding="0" cellspacing="0" class="two-columns"><tbody><tr><td><p>dokku</p></td><td><p>maestro-ng</p></td></tr><tr><td><p>cocaine</p></td><td><p>kubernetes</p></td></tr><tr><td><p>weave</p></td><td><p>deis</p></td></tr><tr><td><p>flynn</p></td><td><p>mesos</p></td></tr><tr><td><p>geard</p></td><td><p>coreos (fleet)</p></td></tr></tbody></table></div><div class="step" step="63" data-x="21000" data-y="1500" data-scale="1"><h1 id="docker-coreos">Docker+CoreOS</h1><pre class="highlight ">[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill busybox1
ExecStartPre=-/usr/bin/docker rm busybox1
ExecStartPre=/usr/bin/docker pull busybox
ExecStart=/usr/bin/docker run --name ...
ExecStop=/usr/bin/docker stop busybox1</pre></div><div class="step" step="64" data-x="23000" data-y="1500" data-scale="1"><h1 id="nix">Nix</h1><ul><li>not-a-virtualisation</li><li>virtualenv for C, Py, Node, ...</li><li>reproducible configs(!)</li></ul></div><div class="step" step="65" data-scale="2" data-x="500" data-y="0"></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html><a href="#/internals" accesskey="i"></a>
<a href="#/tools" accesskey="t"></a>
<a href="#/security" accesskey="s"></a>
<a href="#/resume" accesskey="r"></a>
